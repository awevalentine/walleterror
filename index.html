<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Network DApp</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.05);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        h1 { margin-bottom: 10px; color: #333; }
        
        /* New Network Badge */
        .network-badge {
            display: inline-block;
            background: #eee;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: #666;
            margin-bottom: 20px;
        }
        .network-badge.active { background: #e6f7ff; color: #0077cc; border: 1px solid #bae7ff; }

        .status {
            margin-top: 20px;
            padding: 12px;
            background-color: #e6f7ff;
            border-radius: 12px;
            display: none;
            border: 1px solid #b3e0ff;
        }
        .address { 
            word-break: break-all; 
            color: #0050b3; 
            font-family: monospace; 
            font-size: 14px; 
        }

        .payment-area {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            display: none;
        }
        .input-group { margin-bottom: 15px; text-align: left; }
        label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .send-btn {
            background-color: #10B981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }
        .send-btn:hover { background-color: #059669; }
    </style>
</head>
<body>

<div class="container">
    <h1>My DApp</h1>
    
    <div id="network-badge" class="network-badge">Not Connected</div>
    
    <w3m-button></w3m-button>

    <div id="status-box" class="status">
        <strong>âœ… Connected</strong>
        <div id="wallet-address" class="address">...</div>
    </div>

    <div id="payment-area" class="payment-area">
        <div class="input-group">
            <label>Recipient Address</label>
            <input type="text" id="to-address" placeholder="0x..." value="0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045">
        </div>
        <div class="input-group">
            <label id="currency-label">Amount (ETH)</label>
            <input type="number" id="amount" placeholder="0.001" step="0.0001" value="0.0001">
        </div>
        
        <button id="send-btn" class="send-btn">
            ðŸ’¸ Send Payment
        </button>
    </div>
</div>

<script type="module">
    import { createWeb3Modal, defaultConfig } from 'https://esm.sh/@web3modal/ethers@4.1.0'
    import { BrowserProvider, parseEther } from 'https://esm.sh/ethers@6.10.0'

    const projectId = 'f3dc106518477f154a4341b52589531d'

    // 3. Define Networks with their Currencies
    const mainnet = { chainId: 1, name: 'Ethereum', currency: 'ETH', explorerUrl: 'https://etherscan.io', rpcUrl: 'https://cloudflare-eth.com' }
    const polygon = { chainId: 137, name: 'Polygon', currency: 'MATIC', explorerUrl: 'https://polygonscan.com', rpcUrl: 'https://polygon-rpc.com' }
    const bsc = { chainId: 56, name: 'BNB Smart Chain', currency: 'BNB', explorerUrl: 'https://bscscan.com', rpcUrl: 'https://binance.onfinality.io/public' }

    const metadata = {
        name: 'Smart Network DApp',
        description: 'Auto-updating currency example',
        url: 'https://my-dapp.com', 
        icons: ['https://avatars.githubusercontent.com/u/37784886']
    }

    const modal = createWeb3Modal({
        ethersConfig: defaultConfig({ metadata }),
        chains: [mainnet, polygon, bsc], // Supports ETH, Polygon, and BSC
        projectId,
        enableAnalytics: true
    })

    // UI Elements
    const statusBox = document.getElementById('status-box')
    const addressLabel = document.getElementById('wallet-address')
    const paymentArea = document.getElementById('payment-area')
    const networkBadge = document.getElementById('network-badge')
    const currencyLabel = document.getElementById('currency-label')
    const sendBtn = document.getElementById('send-btn')

    // 4. Helper Function to Update UI
    function updateNetworkUI(chainId) {
        if (!chainId) {
            networkBadge.innerText = "Not Connected"
            networkBadge.className = "network-badge"
            return
        }

        // Find which network we are on
        let networkName = "Unknown Network"
        let symbol = "Tokens"

        if (chainId === 1) { networkName = "Ethereum"; symbol = "ETH"; }
        else if (chainId === 137) { networkName = "Polygon"; symbol = "MATIC"; }
        else if (chainId === 56) { networkName = "BSC"; symbol = "BNB"; }

        // Update the screen
        networkBadge.innerText = `ðŸ“¡ ${networkName}`
        networkBadge.className = "network-badge active"
        currencyLabel.innerText = `Amount (${symbol})`
        sendBtn.innerText = `ðŸ’¸ Send ${symbol}`
    }

    // 5. Advanced Listener (Watches for Address AND Chain changes)
    modal.subscribeProvider(({ address, isConnected, chainId }) => {
        if (isConnected && address) {
            statusBox.style.display = 'block'
            paymentArea.style.display = 'block'
            addressLabel.textContent = address
            
            // Run our new network update logic
            updateNetworkUI(chainId)
        } else {
            statusBox.style.display = 'none'
            paymentArea.style.display = 'none'
            updateNetworkUI(null)
        }
    })

    // Send Logic (Same as before)
    sendBtn.addEventListener('click', async () => {
        const to = document.getElementById('to-address').value
        const amount = document.getElementById('amount').value
        if(!to || !amount) return alert("Please fill in fields")

        try {
            const walletProvider = modal.getWalletProvider()
            const provider = new BrowserProvider(walletProvider)
            const signer = await provider.getSigner()
            
            const tx = await signer.sendTransaction({
                to: to,
                value: parseEther(amount)
            })
            alert(`âœ… Transaction Sent! Hash: ${tx.hash}`)
        } catch (error) {
            console.error(error)
            alert("Transaction cancelled or failed.")
        }
    })
</script>

</body>
</html>
